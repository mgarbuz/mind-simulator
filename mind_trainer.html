<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title></title>
    <style type='text/css'>
            #test{
                display:none;
            }
            #circle_red {
      width: 50px;
      height: 50px;
      -webkit-border-radius: 25px;
      -moz-border-radius: 25px;
      border-radius: 25px;
      background: red;
	  border: 1px solid #000
    }
      #circle_yellow {
      width: 50px;
      height: 50px;
      -webkit-border-radius: 25px;
      -moz-border-radius: 25px;
      border-radius: 25px;
      background: yellow;
	  border: 1px solid #000
    }
      #circle_green {
      width: 50px;
      height: 50px;
      -webkit-border-radius: 25px;
      -moz-border-radius: 25px;
      border-radius: 25px;
      background: green;
	  border: 1px solid #000
    }
      #circle_grey {
      width: 50px;
      height: 50px;
      -webkit-border-radius: 25px;
      -moz-border-radius: 25px;
      border-radius: 25px;
      background: white;
	  border: 1px solid #000
    }
    </style>

</head>
<body>

<h1>
    <time>00:00:00</time>
</h1>
<div id="main_panel"></div>
<div id="second_panel">
<button id="strt">start</button>
<button id="agn" style="display:none">again</button>
<button id="nxt" style="display:none">next</button>
<button id="chk" style="display:none">check</button>
</div>

<button id="finish" style="display:none;" onclick="checkResult()">finish</button>
<div id="result"></div>

<canvas id="myCanvas" width="700" height="200">
    Ваш браузер не поддерживает Canvas
</canvas>

<script type='text/javascript'>

            const color= ['red','yellow','green'];
            var image = document.getElementById("myCanvas");
            var randoms = Array.from({length: 20}, () => Math.floor(Math.random() * 3));	
			for (var j = 0; j < 17; j+=3) {//проверка того, что нет трёх одинаковых цветов подряд в первой фазе
				if((randoms[j]==randoms[j+1]) && (randoms[j+1]==randoms[j+2])){
					randoms[j]=0;
					randoms[j+1]=2;
					randoms[j+2]=1;
					}
				}

			for (var j = 0; j < 12; j+=3) {//проверка того, что нет двух подряд одинаковых троек. НЕ РАБОТАЕТ
				if((randoms[j]==randoms[j+3]) && (randoms[j+1]==randoms[j+4])&& (randoms[j+2]==randoms[j+5])){
					randoms[j]=0;
					randoms[j+1]=2;
					randoms[j+1]=1;
					randoms[j+3]=1;
					randoms[j+4]=2;
					randoms[j+5]=0;
					}
				}	
			for (var j = 15; j < 18; j++) {//проверка того, что в последних пяти кружках нет трёх подряд одинаковых цветов
				if((randoms[j]==randoms[j+1]) && (randoms[j+1]==randoms[j+2])){
					randoms[j]=1;
					randoms[j+1]=0;
					randoms[j+2]=2;
					}
				}				
            var p = 0;

            var i = 0, s = ["block","none"], t = [2000,1000]; //2 сек есть картинка, 1 сек нет
            var count = 0;
            var canvas = document.getElementById("myCanvas"), 
            context = canvas.getContext('2d');
            
            function switchColor(number) {
               var str_res = "";
               var color = document.getElementById('data_' + number).innerHTML;
               color++;
               color = color%3
               var r = color;
               if(r == 0) str_res += "<div id=\"circle_red\"></div>";
               if(r == 1) str_res += "<div id=\"circle_yellow\"></div>";
               if(r == 2) str_res += "<div id=\"circle_green\"></div>";
               document.getElementById("data_" + number).innerHTML = color;
               document.getElementById("circle_" + number).innerHTML = str_res;
        }
            function checkResult() {
               var score = 0;
               for (let i = 0; i < randoms.length; i++) {
                   var answer = document.getElementById("data_"+i).innerHTML;
                   if (answer != randoms[i]) {
                      break;
                   }
                   score++;
               }
               document.getElementById("result").innerHTML = drawTableByArray(randoms, 4, 5);
               alert('Ваш результат:' + score);
            }

            function drawTableByArray(array, rows, columns) {
               var result = "<font size='6'>Правильный ответ:</font> \n\n\n <table>";
               for (let i = 0; i < rows; i++) {
                   result += "<tr>";
                   for (let j = 0; j < columns; j++) {
                       result += "<th>";
                       var r = array[i*columns + j];
	               if(r == 0) result += "<div id=\"circle_red\"></div>";
               	if(r == 1) result += "<div id=\"circle_yellow\"></div>";
               	if(r == 2) result += "<div id=\"circle_green\"></div>";
                       result += "</th>";
                   }
               }
               result += "</table>";
               return result;
            }


            window.onload = function(){

            var h1 = document.getElementsByTagName('h1')[0];
            var start = document.getElementById('strt');
            var next = document.getElementById('nxt');
            var check = document.getElementById('chk');
            var again = document.getElementById('agn');
            var milisec = 0;
            var sec = 0;
            var min = 0;
            var time;
            
            function clearTime() {
                   milisec = 0; sec = 0; min = 0;
            }

            function tick(){
		    milisec+=10;
		    if (milisec >= 100) {
			    milisec = 0;
			    sec++;
			    if (sec >= 60) {
				    sec = 0;
				    min++;
			    }
		    }
            }

            function add() {
		    tick();
		    h1.textContent = (min > 9 ? min : "0" + min) 
		    + ":" + (sec > 9 ? sec : "0" + sec)
		    + ":" + (milisec > 9 ? milisec : "0" + milisec);
		    timer();
            }

            function timer() {
            	time = setTimeout(add, 100);
            }

            //timer();
            //show();
			start.onclick = function() {
			clearInterval();
			document.getElementById("strt").style.display = "none";
			//document.getElementById("main_panel").innerHTML = "<button id='chk'>check</button>";
		    timer();
		    show();
            }

            check.onclick = function() {
            	//clearTimeout(time);
			   image.style.display = "none";
               document.getElementById("main_panel").innerHTML=generateTable();
               document.getElementById("second_panel").style.display = "none";
               document.getElementById("finish").style.display = "block";
            }

            next.onclick = function() {
			image.style.display = "none";
			document.getElementById("nxt").style.display = "none";
			document.getElementById("agn").style.display = "none";
			p=14;
			phase2();
            }
            again.onclick = function() {
			document.getElementById("nxt").style.display = "none";
			document.getElementById("agn").style.display = "none";
		    p=0;
		    count=0;
		    i=0;
		    show();
            }
			
			finish.onclick = function() {
			clearTimeout(time);
			checkResult();
			document.getElementById("finish").style.display = "none";
            }



            function drawCircle(i, j, k, l , color) {
                   context.beginPath();
		    context.arc(i, j, k, l, Math.PI*2, false);
		    context.closePath();
		    context.stroke();
		    context.fillStyle = color;
		    context.fill();
            }

            function show()
            {
		    i ^= 1
		    if(i == 0) {
		    	p += 3;
		    }
		    image.style.display = s[i];
		    
		    if (count < 10) {
			count += 1;
			setTimeout(show,t[i]);
		    } else {
			document.getElementById("agn").style.display = "block";
			document.getElementById("nxt").style.display = "block";
			//phase2();
			//timer();
		    }

                   drawCircle(60, 90, 50, 0, color[randoms[p]]);
                   drawCircle(200, 90, 50, 0, color[randoms[p+1]]);
                   drawCircle(350, 90, 50, 0, color[randoms[p+2]]);
            }

	     function phase2() {
                   setTimeout(phase3, 1000);
	     }
             
             function phase3() {
                   drawCircle(60, 90, 50, 0, color[randoms[p]]);
                   drawCircle(200, 90, 50, 0, color[randoms[p+1]]);
                   drawCircle(350, 90, 50, 0, color[randoms[p+2]]);
                   drawCircle(500, 90, 50, 0, color[randoms[p+3]]);
                   drawCircle(650, 90, 50, 0, color[randoms[p+4]]);
                   image.style.display = "block";
				   document.getElementById("chk").style.display = "block";
             }

            //show()

            function generateTable() {
               var result = "<table>" 
                            + generateRow(0)
                            + generateRow(5)
                            + generateRow(10)
                            + generateRow(15)
                            + "</table>";
               return result;
        }
        function generateRow(row) {
               var result = "<tr>" 
                          + generateCell(row+0) + generateCell(row+1) + generateCell(row+2) + generateCell(row+3) + generateCell(row+4)
			   + "</tr>";
               return result;
        }
        function generateCell(id) {
               var result = "<th id=\""+id + "\" onclick=\"switchColor('" + id + "')\">\
                   <div id=\"data_" + id + "\" style=\"display:none\">" + -1 + "</div>\
                   <div id=\"circle_" + id + "\">\
                        <div id=\"circle_grey\"></div>\
                   </div>\
               </th>";
               return result;
        }

            }					

</script>
</body>
</html>
